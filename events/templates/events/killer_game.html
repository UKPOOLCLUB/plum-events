{% extends "base.html" %}
{% load static %}
{% load killer_extras %}

{% block content %}

<script>
  document.body.dataset.pollingUrl = "{% url 'killer_game_state' event.id %}";
</script>

<div class="container mt-3">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="mb-0">ğŸ± Killer Pool</h4>
    <a href="{% url 'live_leaderboard' event.code %}" class="text-decoration-none" title="Return to leaderboard">
      <i class="bi bi-bar-chart-fill fs-4"></i>
    </a>
  </div>
    <br>

  <!-- Top Banner -->
  {% if killer.is_complete %}
    <div class="alert alert-success py-2 mb-3 text-center">
      ğŸ† <strong>{{ players|get_winner_name }} wins!</strong> Game over.
    </div>
  {% else %}
    <div class="alert alert-primary py-2 mb-3 text-center">
      <strong>It's {{ current_player.participant.username }}'s turn</strong>
    </div>
  {% endif %}

{% if not killer.is_complete and next_player %}
  <div class="text-center text-white-50 mb-3">
    <small>ğŸ¯ <strong>Next:</strong> {{ next_player.participant.username }}</small>
  </div>
{% endif %}

  <div class="row gx-2 gy-3">

    <!-- Action Buttons -->
{% if not killer.is_complete %}
  <div class="col-12 col-md-6">

    <form method="post" action="{% url 'killer_submit_turn' event.id %}">
      {% csrf_token %}

      <!-- Row 1: Successful Pot -->
      <div class="d-grid mb-2">
        <button name="action" value="successful_pot" class="btn btn-success btn-sm text-center rounded-pill">
          âœ… Successful Pot
        </button>
      </div>

      <!-- Row 2: Lose 1 & 2 Lives -->
      <div class="d-flex gap-2 mb-2">
        <button name="action" value="lose_one_life" class="btn btn-danger btn-sm w-50 rounded-pill">
          âŒ Lose 1 Life
        </button>
        <button name="action" value="lose_two_lives" class="btn btn-danger btn-sm w-50 rounded-pill">
          âŒâŒ Lose 2 Lives
        </button>
      </div>

      <!-- Row 3: Add Life & Manual Navigation -->
      <div class="d-flex gap-2 mb-2">
        <button name="action" value="add_life" class="btn btn-warning btn-sm w-50 rounded-pill">
          ğŸ± Add Life
        </button>
        <button name="action" value="move_back" class="btn btn-secondary btn-sm w-50 rounded-pill">
          â¬…ï¸ Move Turn Back
        </button>
      </div>

      <!-- Row 4: Move Turn Forward -->
      <div class="d-grid">
        <button name="action" value="move_forward" class="btn btn-secondary btn-sm rounded-pill">
          â¡ï¸ Move Turn Forward
        </button>
      </div>
    </form>

  </div>
{% endif %}


    <!-- Player List -->
    <div class="col-12 col-md-6">
      <div class="table-responsive">
        <table class="table table-dark table-borderless table-sm align-middle text-center">
          <thead class="table-light text-dark">
            <tr>
              <th>Player</th>
              <th>Status</th>
              <th>Lives</th>
            </tr>
          </thead>
          <tbody>
            {% with sorted_players=players %}
              {% if killer.is_complete %}
                {% with sorted_players=players|dictsort:"finish_position" %}{% endwith %}
              {% endif %}
              {% for player in sorted_players %}
                <tr class="
                  {% if player == current_player and not killer.is_complete %}killer-current fw-bold text-accent killer-highlight{% endif %}
                  {% if player.eliminated %}killer-eliminated{% endif %}
                ">
                  <td>
                    {% if killer.is_complete and player.finish_position == 1 %}
                      ğŸ† <strong>{{ player.participant.username }}</strong><br>
                      <small class="text-success">(1st â€“ {{ player.points_awarded }} pts)</small>
                    {% else %}
                      {{ player.participant.username }}
                    {% endif %}
                  </td>
                  <td>
                    {% if player.eliminated %}
                      Out ({{ player.finish_position|ordinal }})
                    {% elif player == current_player %}
                      ğŸ¯ Your Turn
                    {% else %}
                      â€”
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-secondary px-2 py-1">{{ player.lives }} ğŸ§¡</span>
                  </td>
                </tr>
              {% endfor %}
            {% endwith %}
          </tbody>
        </table>
      </div>
    </div>

<style>
/* Highlight pulse for current player */
@keyframes pulse {
  0% { background-color: rgba(255, 255, 255, 0.05); }
  50% { background-color: rgba(255, 255, 255, 0.15); }
  100% { background-color: rgba(255, 255, 255, 0.05); }
}

.killer-current {
  animation: pulse 2s infinite;
  font-weight: bold;
}

/* Fade and dull eliminated players */
.killer-eliminated {
  opacity: 0.5;
  text-decoration: line-through;
}
</style>

<style>
.killer-action-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.75rem;
  max-width: 280px;
  margin: 0 auto 1.5rem;
}

.killer-action-btn {
  width: 100%;
  aspect-ratio: 1 / 1;
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0.5rem;
  background-color: #1e1e1e;
  color: #fff;
  border: 2px solid #333;
  transition: all 0.2s ease-in-out;
}

.killer-action-btn:hover {
  background-color: #333;
  transform: scale(1.05);
}
/* Current player's row highlight */
.killer-current {
  background-color: rgba(255, 255, 255, 0.05);
  font-weight: bold;
}

/* Eliminated player style */
.killer-eliminated {
  opacity: 0.5;
  text-decoration: line-through;
}

.btn-success {
  background-color: #00ff84;
  color: black;
  box-shadow: 0 0 10px #00ff84;
}

.btn-danger {
  background-color: #ff4d4d;
  color: white;
  box-shadow: 0 0 10px #ff4d4d;
}

.btn-warning {
  background-color: #ffc107;
  color: black;
  box-shadow: 0 0 10px #ffc107;
}

.btn-secondary {
  background-color: #6c757d;
  color: white;
  box-shadow: 0 0 10px #999;
}

.btn {
  min-width: 140px;
}
</style>

<script>
  async function pollKillerGameState() {
    const url = document.body.dataset.pollingUrl;
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error("Poll failed");
      const data = await response.json();
      updateKillerGameUI(data);
    } catch (err) {
      console.error("Polling error:", err);
    }
  }

  function updateKillerGameUI(data) {
    const banner = document.querySelector(".alert-primary, .alert-success");
    if (data.is_complete) {
      banner.classList.remove("alert-primary");
      banner.classList.add("alert-success");
      banner.innerHTML = `ğŸ† <strong>${data.players.find(p => p.finish_position === 1)?.username} wins!</strong> Game over.`;
    } else {
      banner.classList.remove("alert-success");
      banner.classList.add("alert-primary");
      banner.innerHTML = `<strong>It's ${data.current_player}'s turn</strong>`;
    }

    // Update player table
    const rows = document.querySelectorAll("tbody tr");
    rows.forEach((row, index) => {
      const player = data.players[index];
      row.classList.remove("killer-current", "killer-eliminated", "text-accent");
      row.children[0].innerHTML = player.finish_position === 1
        ? `ğŸ† <strong>${player.username}</strong><br><small class="text-success">(1st â€“ ${player.points_awarded} pts)</small>`
        : player.username;

      row.children[1].innerHTML = player.eliminated
        ? `Out (${ordinal(player.finish_position)})`
        : player.is_current ? "ğŸ¯ Your Turn" : "â€”";

      row.children[2].innerHTML = `<span class="badge bg-secondary px-2 py-1">${player.lives} ğŸ§¡</span>`;

      if (player.eliminated) {
        row.classList.add("killer-eliminated");
      } else if (player.is_current) {
        row.classList.add("killer-current", "text-accent");
      }
    });
  }

  function ordinal(n) {
    if (!n) return "";
    const s = ["th", "st", "nd", "rd"], v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
  }

  // Start polling every 5 seconds
  setInterval(pollKillerGameState, 5000);
</script>
</div>

{% endblock %}
