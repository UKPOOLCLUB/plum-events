{% extends "base.html" %}
{% load pool_match_filters %}

{% block content %}
<style>
  .league-header {
    color: #00FFAB;
    text-shadow: 0 0 6px #00FFAB;
  }
</style>

<script>
  document.body.dataset.pollingUrl = "{% url 'pool_league_state' event.id %}";
</script>

<div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
  <h2 class="mb-0 league-header">ðŸŽ± Pool League Match Grid</h2>
  <a href="{% url 'live_leaderboard' event.code %}" class="text-decoration-none" title="Return to leaderboard">
    <i class="bi bi-bar-chart-fill fs-1"></i>
  </a>
</div>

<div id="pool-league-container">
  {% include "events/partials/pool_league_update.html" %}
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function initSubmitButtons() {
    document.querySelectorAll(".submit-button").forEach(button => {
      button.addEventListener("click", function () {
        const form = this.closest("form");
        const formData = new FormData(form);
        const result = this.dataset.result;

        formData.set("result", result);

        fetch(form.action, {
          method: "POST",
          body: formData,
          headers: {
            "X-CSRFToken": getCookie("csrftoken")
          }
        })
        .then(res => res.text())
        .then(html => {
          document.getElementById("pool-league-container").innerHTML = html;
          initSubmitButtons();  // âœ… re-activate buttons after content reload
        })
        .catch(err => alert("Error submitting result"));
      });
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    initSubmitButtons();

    // âœ… Start polling
    const pollingUrl = document.body.dataset.pollingUrl;
    let lastState = null;

let lastHash = null;

setInterval(() => {
  fetch(pollingUrl)
    .then(res => res.json())
    .then(data => {
      if (!lastHash) {
        lastHash = data.state_hash;
        return;
      }

      if (data.state_hash !== lastHash) {
        fetch(window.location.href, { headers: { "X-Requested-With": "XMLHttpRequest" } })
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const updatedContainer = doc.getElementById("pool-league-container");
            if (updatedContainer) {
              document.getElementById("pool-league-container").innerHTML = updatedContainer.innerHTML;
              initSubmitButtons();  // rebind after update
              lastHash = data.state_hash;
            }
          });
      }
    });
}, 2000);
  });
</script>

{% endblock %}
