{% extends "base.html" %}
{% load pool_match_filters %}

{% block content %}

<style>
  .league-header {
    color: #00FFAB;
    text-shadow: 0 0 6px #00FFAB;
  }

  .matrix-table th,
  .matrix-table td {
    vertical-align: middle;
  }

  .matrix-table .text-success,
  .matrix-table .text-danger {
    font-size: 1.2rem;
  }

  .clickable-result-cell {
    cursor: pointer;
    border: 2px dashed #FFD700;
    background-color: #222;
    transition: background-color 0.2s ease;
  }

  .clickable-result-cell:hover {
    background-color: #333;
  }

  .matrix-table th:first-child,
  .matrix-table td:first-child {
    font-weight: bold;
    color: #00FFAB;
    white-space: nowrap;
  }

  .matrix-table td:last-child {
    background-color: rgba(0, 255, 171, 0.05);
    font-weight: bold;
  }

  .modal-content {
    background-color: #1E1E2F;
    border: 1px solid #00FFAB;
    color: #fff;
  }

  .modal-title {
    color: #00FFAB;
  }

  .btn-close {
    filter: invert(1);
  }
</style>

<script>
  document.body.dataset.pollingUrl = "{% url 'pool_league_state' event.id %}";
</script>

<div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
    <div>
        <h2 class="mb-0 league-header">üé± Pool League Match Grid</h2>
    </div>
    <a href="{% url 'live_leaderboard' event.code %}" class="text-decoration-none" title="Return to leaderboard">
        <i class="bi bi-bar-chart-fill fs-1"></i>
    </a>
</div>

{% if league_completed %}
    <div class="alert alert-success text-center mt-5">
        <h4 class="mb-3">üèÜ Pool League Completed!</h4>
        <p>Here are the final standings:</p>

        <table class="table table-dark table-bordered text-center mt-4 matrix-table">
            <thead class="table-dark">
                <tr>
                    <th>Rank</th>
                    <th>Player</th>
                    <th>Wins</th>
                    <th>Points Awarded</th>
                </tr>
            </thead>
            <tbody>
                {% for player in standings %}
                    <tr>
                        <td>{{ player.finish_rank }}</td>
                        <td>{{ player.participant.username }}</td>
                        <td>{{ player.wins }}</td>
                        <td>{{ player.points_awarded }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endif %}

<table class="table table-dark table-bordered text-center align-middle matrix-table">
    <thead>
        <tr>
            <th>Player</th>
            {% for col_player in players %}
                <th>{{ col_player.participant.username }}</th>
            {% endfor %}
            <th>Total Wins</th>
        </tr>
    </thead>
    <tbody>
        {% for row_player in players %}
            <tr>
                <th>{{ row_player.participant.username }}</th>
                {% for col_player in players %}
                    {% if row_player == col_player %}
                        <td class="bg-light">‚Äî</td>
                    {% else %}
                        {% with key=row_player.id|match_key:col_player.id %}
                            {% with match=matches|get_match:key %}
                                {% if match %}
                                    {% if match.completed %}
                                        {% if match.winner_id == row_player.id %}
                                            <td class="text-success">‚úÖ</td>
                                        {% else %}
                                            <td class="text-danger">‚ùå</td>
                                        {% endif %}
                                    {% else %}
                                        <td class="clickable-result-cell bg-warning text-dark"
                                            data-match-id="{{ match.id }}"
                                            data-player1="{{ match.player1.participant.username }}"
                                            data-player1-id="{{ match.player1.id }}"
                                            data-player2="{{ match.player2.participant.username }}"
                                            data-player2-id="{{ match.player2.id }}">
                                            Select
                                        </td>
                                    {% endif %}
                                {% else %}
                                    <td></td>
                                {% endif %}
                            {% endwith %}
                        {% endwith %}
                    {% endif %}
                {% endfor %}
                <td><strong>{{ row_player.wins }}</strong></td>
            </tr>
        {% endfor %}
    </tbody>
</table>




<!-- Result Submission Modal -->
<div class="modal fade" id="submitResultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Submit Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p id="matchup" class="mb-3"></p>
                <button class="btn btn-success m-2" id="btn-player1-win"></button>
                <button class="btn btn-primary m-2" id="btn-player2-win"></button>
            </div>
        </div>
    </div>
</div>

<script>
document.querySelectorAll('.clickable-result-cell').forEach(cell => {
    cell.addEventListener('click', () => {
        const matchId = cell.dataset.matchId;
        const p1 = cell.dataset.player1;
        const p2 = cell.dataset.player2;
        const p1Id = cell.dataset.player1Id;
        const p2Id = cell.dataset.player2Id;

        document.getElementById('matchup').textContent = `${p1} vs ${p2}`;
        const btn1 = document.getElementById('btn-player1-win');
        const btn2 = document.getElementById('btn-player2-win');

        btn1.textContent = `${p1} wins`;
        btn2.textContent = `${p2} wins`;

        btn1.onclick = () => submitResult(matchId, p1Id);
        btn2.onclick = () => submitResult(matchId, p2Id);

        new bootstrap.Modal(document.getElementById('submitResultModal')).show();
    });
});

function submitResult(matchId, winnerId) {
    fetch("{% url 'submit_pool_match_result' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `match_id=${matchId}&winner_id=${winnerId}`
    }).then(res => res.json()).then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || "Error submitting result");
        }
    });
}
</script>

{% endblock %}
