{% extends "base.html" %}
{% load golf_extras %}

{% block content %}
<h2 class="text-center mb-4">Mini-Golf â€“ Group Scorecard</h2>

<p class="text-center text-muted">
    Scorekeeper: <strong>{{ scorekeeper.username }}</strong>
</p>

<form method="post">
    {% csrf_token %}
    <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
            <tr>
                <th>Player</th>
                {% if holes|length == 18 %}
                    {% for hole in holes|slice:":9" %}<th>{{ hole }}</th>{% endfor %}
                    <th>Front 9</th>
                    {% for hole in holes|slice:"9:" %}<th>{{ hole }}</th>{% endfor %}
                    <th>Back 9</th>
                {% else %}
                    {% for hole in holes %}<th>{{ hole }}</th>{% endfor %}
                {% endif %}
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for player in players %}
            <tr {% if player == scorekeeper %}class="table-info"{% endif %}>
                <td>
                    {{ player.username }}
                    {% if player == scorekeeper %}
                        <span class="badge bg-primary ms-1">Scorekeeper</span>
                    {% endif %}
                </td>

                {% if holes|length == 18 %}
                    {% for hole in holes|slice:":9" %}
                        <td>
                            {% include "events/partials/hole_input.html" with player=player hole=hole %}
                        </td>
                    {% endfor %}
                    <td id="front9_{{ player.username }}"><strong>0</strong></td>

                    {% for hole in holes|slice:"9:" %}
                        <td>
                            {% include "events/partials/hole_input.html" with player=player hole=hole %}
                        </td>
                    {% endfor %}
                    <td id="back9_{{ player.username }}"><strong>0</strong></td>
                {% else %}
                    {% for hole in holes %}
                        <td>
                            {% include "events/partials/hole_input.html" with player=player hole=hole %}
                        </td>
                    {% endfor %}
                {% endif %}

                <td id="total_{{ player.username }}"><strong>0</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>


    {% if can_edit %}
        <div class="text-center mt-3">
            <button type="submit" class="btn btn-success">Submit Scores</button>
        </div>
    {% endif %}
</form>

<div class="text-center mt-4">
    <a href="{% url 'live_leaderboard' event.code %}" class="btn btn-secondary">Back to Leaderboard</a>
</div>

<style>
/* Remove number input spinners for all browsers */
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
input[type=number] {
    -moz-appearance: textfield; /* Firefox */
    text-align: center;
    padding: 4px;
    font-weight: bold;
    font-size: 16px;
    width: 45px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const inputs = document.querySelectorAll('.score-input');

    function updateTotals() {
    const playerScores = {};

    document.querySelectorAll('.score-input').forEach(input => {
        const username = input.dataset.username;
        const hole = parseInt(input.dataset.hole);
        const strokes = parseInt(input.value) || 0;

        if (!playerScores[username]) {
            playerScores[username] = {
                front9: 0,
                back9: 0,
                total: 0
            };
        }

        if (hole <= 9) {
            playerScores[username].front9 += strokes;
        } else {
            playerScores[username].back9 += strokes;
        }

        playerScores[username].total += strokes;
    });

    for (const [username, totals] of Object.entries(playerScores)) {
        const frontCell = document.getElementById(`front9_${username}`);
        const backCell = document.getElementById(`back9_${username}`);
        const totalCell = document.getElementById(`total_${username}`);

        if (frontCell) frontCell.innerHTML = `<strong>${totals.front9}</strong>`;
        if (backCell) backCell.innerHTML = `<strong>${totals.back9}</strong>`;
        if (totalCell) totalCell.innerHTML = `<strong>${totals.total}</strong>`;
    }
}

    // Save score on input change
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            updateTotals();

            const username = input.dataset.username;
            const hole = input.dataset.hole;
            const strokes = input.value;

            // Logging for debug
            console.log("Saving score", {
                group_id: "{{ group.id }}",
                username: username,
                hole: hole,
                strokes: strokes
            });

            fetch("{% url 'save_golf_score' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: new URLSearchParams({
                    group_id: "{{ group.id }}",
                    username: username,
                    hole: hole,
                    strokes: strokes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error("Failed to save score:", data.error);
                }
            })
            .catch(error => {
                console.error("AJAX error saving score:", error);
            });
        });
    });

    // Calculate totals on page load
    updateTotals();
});
</script>

{% endblock %}
