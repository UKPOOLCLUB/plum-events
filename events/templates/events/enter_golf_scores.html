{% extends "base.html" %}
{% load golf_extras %}

{% block content %}

{% if group.id %}
<script>
  document.body.dataset.pollingUrl = "{% url 'golf_scorecard_state' group.id %}";
</script>
{% endif %}

<div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
  <div>
    <h2 class="mb-0">Mini-Golf Scorecard</h2>
    <p class="text-light mb-0">Scorekeeper: <strong>{{ scorekeeper.username }}</strong></p>
  </div>
  <a href="{% url 'live_leaderboard' event.code %}" class="text-decoration-none" title="Return to leaderboard">
    <i class="bi bi-bar-chart-fill fs-1"></i>
  </a>
</div>

{% if can_edit and not scorecard.submitted %}
<form method="post" action="{% url 'submit_golf_scorecard' group.id %}">
  {% csrf_token %}
{% endif %}

<!-- Front 9 Table (shown in both 9-hole and 18-hole games) -->
<h5 class="text-center mt-4">Front 9</h5>
<table class="table table-bordered text-center align-middle mb-4">
  <thead class="table-light">
    <tr>
      <th>Player</th>
      {% for hole in holes|slice:":9" %}<th>{{ hole }}</th>{% endfor %}
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    {% for player in players %}
    <tr {% if player == scorekeeper %}class="table-info"{% endif %}>
      <td>{{ player.username }}</td>
      {% for hole in holes|slice:":9" %}
        <td>{% include "events/partials/hole_input.html" with player=player hole=hole %}</td>
      {% endfor %}
      <td id="front9_{{ player.username }}"><strong>0</strong></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Back 9 Table (only shown for 18-hole games) -->
{% if holes|length == 18 %}
<h5 class="text-center">Back 9</h5>
<table class="table table-bordered text-center align-middle mb-4">
  <thead class="table-light">
    <tr>
      <th>Player</th>
      {% for hole in holes|slice:"9:" %}<th>{{ hole }}</th>{% endfor %}
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    {% for player in players %}
    <tr {% if player == scorekeeper %}class="table-info"{% endif %}>
      <td>{{ player.username }}</td>
      {% for hole in holes|slice:"9:" %}
        <td>{% include "events/partials/hole_input.html" with player=player hole=hole %}</td>
      {% endfor %}
      <td id="back9_{{ player.username }}"><strong>0</strong></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<!-- Totals Row (always shown) -->
<h5 class="text-center">Total Score</h5>
<table class="table table-bordered text-center align-middle">
  <thead class="table-light">
    <tr>
      <th>Player</th>
      <th>Total Strokes</th>
    </tr>
  </thead>
  <tbody>
    {% for player in players %}
    <tr {% if player == scorekeeper %}class="table-info"{% endif %}>
      <td>{{ player.username }}</td>
      <td id="total_{{ player.username }}"><strong>0</strong></td>
    </tr>
    {% endfor %}
  </tbody>
</table>


{% if can_edit and not scorecard.submitted %}
  <div class="text-center">
    <button type="submit" class="btn btn-primary mt-3">Submit Final Scorecard</button>
  </div>
</form>
{% elif scorecard.submitted %}
  <p class="text-center mt-3 text-success fw-bold">âœ… Scorecard Submitted</p>
{% endif %}

<style>
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
input[type=number] {
    -moz-appearance: textfield;
    text-align: center;
    padding: 4px;
    font-weight: bold;
    font-size: 16px;
    width: 45px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const inputs = document.querySelectorAll('.score-input');

    function updateTotals() {
        const playerScores = {};

        inputs.forEach(input => {
            const username = input.dataset.username;
            const hole = parseInt(input.dataset.hole);
            const strokes = parseInt(input.value) || 0;

            if (!playerScores[username]) {
                playerScores[username] = { front9: 0, back9: 0, total: 0 };
            }

            if (hole <= 9) {
                playerScores[username].front9 += strokes;
            } else {
                playerScores[username].back9 += strokes;
            }

            playerScores[username].total += strokes;
        });

        for (const [username, totals] of Object.entries(playerScores)) {
            document.getElementById(`front9_${username}`).innerHTML = `<strong>${totals.front9}</strong>`;
            document.getElementById(`back9_${username}`).innerHTML = `<strong>${totals.back9}</strong>`;
            document.getElementById(`total_${username}`).innerHTML = `<strong>${totals.total}</strong>`;
        }
    }

    inputs.forEach(input => {
        input.addEventListener('input', updateTotals);
    });

    updateTotals();
});
</script>

{% endblock %}
